<div class="relative overflow-hidden">

  <module-header title={{title}}>
    <entrega-insumo-breadcrumbs breadcrumbs>
      <li><a routerLink="/system/control-medico/entrega-insumos/form">Formulario</a></li>
      <li *ngIf="currentSuppliesDelivery.patient"><a>{{currentSuppliesDelivery.patient.person.names}}</a>
      </li>
    </entrega-insumo-breadcrumbs>
    <div tabs class="h-8"></div>
  </module-header>

  <div class=" w-full h-[calc(100vh-4rem-9rem+12px)] bg-white border-t-[1px] border-[#535a6650] relative">
    <div class="absolute top-0 left-0 w-56 h-full bg-primary">

      <div *ngIf="loading" class="h-full">
        <loader *ngIf="loading"></loader>
      </div>

      <div *ngIf="!loading" class="w-full flex justify-center items-center flex-col p-4 my-5">
        <div tabindex="0" class="avatar">
          <div class="w-20 mask mask-squircle">
            <div class="inline-flex overflow-hidden relative justify-center items-center w-20 h-20 bg-white">
              <span class="font-bold text-neutral text-2xl uppercase">{{currentSuppliesDelivery.patient.person |
                NameInitials}}</span>
            </div>
          </div>
        </div>
        <div class="w-full flex justify-center items-center flex-col mt-2">
          <span class="font-medium text-base text-white">{{currentSuppliesDelivery.patient.person.names}}</span>
          <span class="font-medium text-base text-white">{{currentSuppliesDelivery.patient.person.last_names}}</span>
        </div>
      </div>

      <div *ngIf="!loading" class="w-full h-[calc(100%-208px)] flex justify-between items-start flex-col">

        <div class="px-6">
          <div>
            <h1 class="text-white font-semibold mb-1 -ml-1">Información:</h1>
            <div class="text-sm ">
              <div class="text-white">
                <span class="font-medium opacity-80 mr-1">Cédula:</span><span
                  class="opacity-70 font-normal">{{currentSuppliesDelivery.patient.person.identification}}</span>
              </div>
              <div class="text-white">
                <span class="font-medium opacity-80 mr-1">Edad:</span><span
                  class="opacity-70 font-normal">{{currentSuppliesDelivery.patient.person.date_birth | Age}} años</span>
              </div>
              <div class="text-white">
                <span class="font-medium opacity-80 mr-1">Región:</span><span class="opacity-70 font-normal">
                  {{currentSuppliesDelivery.patient.person.region.value}}</span>
              </div>
              <div class="text-white">
                <span class="font-medium opacity-80 mr-1">Provincia:</span><span class="opacity-70 font-normal">
                  {{currentSuppliesDelivery.patient.person.province}}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="w-full p-6">
          <h1 class="text-white font-semibold mb-1 -ml-1">Diabetes:</h1>
          <div class="flex justify-center items-center bg-neutral-content text-neutral p-2 rounded-md">
            <h3 class="font-medium ">{{currentSuppliesDelivery.patient.medical_record.diabetes_type.value}}</h3>
          </div>
        </div>
      </div>

    </div>


    <div *ngIf="loading" class="ml-56 h-full">
      <loader *ngIf="loading"></loader>
    </div>

    <div *ngIf="!loading" class="w-[calc(100%-14rem)] ml-56 h-full overflow-y-auto p-8">
      <div class="w-full grid grid-cols-2 gap-4" *ngIf="!params_delivery_id">
        <div class="bg-neutral-content border-[1px] border-[#535a6650] rounded-md py-4 px-8 text-neutral">
          <div class="flex justify-between items-center">
            <div class="flex justify-start items-center gap-2">
              <div class="w-12 h-12 flex justify-center items-center bg-[#3f51b530] rounded-md">
                <span class="fas fa-syringe text-2xl text-primary flex justify-center items-center"></span>
              </div>
              <div>
                <h1 class="font-medium">Dosis Basal <span class="font-normal text-sm opacity-80">(requerida)</span>
                </h1>
              </div>
            </div>
            <div>
              <h3 class="font-medium">Total: <span
                  class="font-normal ">{{currentSuppliesDelivery.patient.medical_record.morning_basal_dose +
                  currentSuppliesDelivery.patient.medical_record.evening_basal_dose}}</span></h3>
            </div>
          </div>

          <div class="grid grid-rows-3 grid-cols-2 gap-4 h-32 pt-4">
            <div
              class=" row-span-3 flex justify-center items-center bg-white rounded-md h-full border-[1px] border-[#535a6650] relative overflow-hidden">
              <div class="flex justify-center items-center text-2xl font-bold mr-[18px]">
                <div>
                  <span class="las la-syringe text-lg"></span>
                </div>
                {{currentSuppliesDelivery.patient.medical_record.morning_basal_dose}}
              </div>
              <div class="absolute left-2 bottom-2 flex justify-center items-center gap-1 text-sm">
                <div>
                  <span class="fa-regular fa-sun"></span>
                </div>
                <h3>Mañana</h3>
              </div>
            </div>

            <div
              class="row-span-3 flex justify-center items-center bg-white rounded-md h-full border-[1px] border-[#535a6650] relative overflow-hidden">
              <div class="flex justify-center items-center text-2xl font-bold mr-[18px]">
                <div>
                  <span class="las la-syringe text-lg"></span>
                </div>
                {{currentSuppliesDelivery.patient.medical_record.evening_basal_dose}}
              </div>
              <div class="absolute left-2 bottom-2 flex justify-center items-center gap-1 text-sm">
                <div>
                  <span class="fa-regular fa-moon"></span>
                </div>
                Noche
              </div>
            </div>
          </div>
        </div>

        <div class="bg-neutral-content border-[1px] border-[#535a6650] rounded-md py-4 px-8 text-neutral">
          <div class="flex justify-between items-center">
            <div class="flex justify-start items-center gap-2">
              <div class="w-12 h-12 flex justify-center items-center bg-[#3f51b530] rounded-md">
                <span class="fas fa-syringe text-2xl text-primary flex justify-center items-center"></span>
              </div>
              <div>
                <h1 class="font-medium">Dosis Bolus <span class="font-normal text-sm opacity-80">(requerida)</span>
                </h1>
              </div>
            </div>
            <div>
              <h3 class="font-medium leading-none">Total: <span
                  class="font-normal ">{{currentSuppliesDelivery.patient.medical_record.breakfast_prandial_dose +
                  currentSuppliesDelivery.patient.medical_record.lunch_prandial_dose +
                  currentSuppliesDelivery.patient.medical_record.dinner_prandial_dose +
                  currentSuppliesDelivery.patient.medical_record.correction_prandial_dose}}</span></h3>
            </div>
          </div>

          <div class="grid grid-rows-3 grid-cols-3 gap-x-4 gap-y-1 h-32 pt-4">
            <div
              class="row-span-2 flex justify-center items-center flex-row-reverse bg-white rounded-md h-full border-[1px] border-[#535a6650] relative overflow-hidden">
              <div class="flex justify-center items-center text-2xl font-bold mr-[18px]">
                <div>
                  <span class="las la-syringe text-lg"></span>
                </div>
                {{currentSuppliesDelivery.patient.medical_record.breakfast_prandial_dose}}
              </div>
              <div class="absolute left-2 bottom-2 flex justify-center items-center gap-1 text-sm">
                <div>
                  <span class="fa-regular fa-clock"></span>
                </div>
                <h3>Desayuno</h3>
              </div>
            </div>

            <div
              class="row-span-2 flex justify-center items-center bg-white rounded-md h-full border-[1px] border-[#535a6650] relative overflow-hidden">
              <div class="flex justify-center items-center text-2xl font-bold mr-[18px]">
                <div>
                  <span class="las la-syringe text-lg"></span>
                </div>
                {{currentSuppliesDelivery.patient.medical_record.lunch_prandial_dose}}
              </div>
              <div class="absolute left-2 bottom-2 flex justify-center items-center gap-1 text-sm">
                <div>
                  <span class="fa-regular fa-clock"></span>
                </div>
                <h3>Almuerzo</h3>
              </div>
            </div>

            <div
              class="row-span-2 flex justify-center items-center bg-white rounded-md h-full border-[1px] border-[#535a6650] relative overflow-hidden">
              <div class="flex justify-center items-center text-2xl font-bold mr-[18px]">
                <div>
                  <span class="las la-syringe text-lg"></span>
                </div>
                {{currentSuppliesDelivery.patient.medical_record.dinner_prandial_dose}}
              </div>
              <div class="absolute left-2 bottom-2 flex justify-center items-center gap-1 text-sm">
                <div>
                  <span class="fa-regular fa-clock"></span>
                </div>
                <h3>Merienda</h3>
              </div>
            </div>

            <div
              class="row-span-1 col-span-3 flex justify-center items-center bg-white rounded-md h-full border-[1px] border-[#535a6650] relative overflow-hidden">
              <div class="flex items-center gap-1 text-sm">
                <span class="fa-regular fa-clock"></span>
                <h3>Corrección:</h3>
                <div>
                  <span class="las la-syringe text-lg"></span>
                  <span
                    class="text-lg font-bold">{{currentSuppliesDelivery.patient.medical_record.correction_prandial_dose}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="params_delivery_id">
        <h1 class="font-medium text-neutral">Entregado por: <span
            class="opacity-50">{{currentSuppliesDelivery.delivered_by | NamesSurnamesComplete}}
            (C.I.:{{currentSuppliesDelivery.delivered_by.identification}})</span></h1>
      </div>

      <div *ngIf="!params_delivery_id">
        <div class="py-4 flex justify-between items-center text-neutral">
          <h1 class="font-medium">Entrega mensual</h1>
          <h1 class="opacity-80 capitalize text-sm ">{{today | date: 'dd-MM-yyyy'}}</h1>
        </div>

        <div class="flex justify-between mb-4">
          <div class="w-1/2">
            <div class="relative">
              <div class="flex absolute inset-y-0 left-0 items-center pl-3 pointer-events-none">
                <span class="fa-solid fa-magnifying-glass"></span>
              </div>
              <input type="text" #search (keyup)="searchSuppliesByTem(search.value)"
                class="input input-sm block h-8 p-2 pl-10 w-full max-w-xs text-sm text-neutral bg-[#ebecf0] !border-[#535A6640] rounded-md border !outline-[#535A6620]"
                placeholder="Buscar">
            </div>
          </div>
        </div>
      </div>

      <div class="min-h-[calc(100vh-25rem)] w-full flex justify-between gap-4"
        [ngClass]="{'!min-h-[calc(100vh-20rem)]': params_delivery_id}">
        <div class="w-full h-full">

          <div class="py-4 flex justify-between items-center text-neutral" *ngIf="params_delivery_id">
            <h1 class="font-medium">Entrega mensual</h1>
            <h1 class="opacity-80 capitalize text-sm ">{{currentSuppliesDelivery.created_at | date: 'dd-MM-yyyy'}}</h1>
          </div>

          <div class="w-full h-full overflow-hidden border border-[#535a6650] rounded-md">
            <table class="my_table w-full text-sm text-left text-neutral" *ngIf="!params_delivery_id">
              <thead class="text-xs text-primary uppercase bg-[#dbdef1] border-b border-[#535a6650] sticky top-0">
                <tr>
                  <th scope="col" class="py-3 px-6">

                  </th>
                  <th scope="col" class="py-3 px-6">
                    Insumos
                  </th>
                  <th scope="col" class="py-3 px-6">
                    Cantidad
                  </th>
                </tr>
              </thead>
              <tbody *ngIf="!loading" class="divide-y-[0.5px] divide-[#535A6640]">
                <tr class="bg-white hover:bg-neutral-content transition-all"
                  *ngFor="let insumo of catalogoInsumos;let index = index">
                  <th class="py-2 px-6 w-20">
                    <div class="w-12 h-12 flex justify-center items-center bg-[#3f51b530] rounded-md">
                      <span class="fas fa-syringe text-2xl text-primary flex justify-center items-center"></span>
                    </div>
                  </th>
                  <td class="py-2 px-6 font-medium text-neutral whitespace-nowrap dark:text-neutral capitalize">
                    {{insumo.insumo.value}}
                  </td>
                  <td class="py-2 px-6 w-20">
                    <div class="flex items-center space-x-3">
                      <button
                        [disabled]="insumo.cantidad == 0 || insumo.cantidad == null || insumo.cantidad == undefined"
                        [ngClass]="{'opacity-50 cursor-not-allowed': insumo.cantidad == 0 || insumo.cantidad == null || insumo.cantidad == undefined}"
                        (click)="subtractSupply(insumo.insumo)"
                        class="inline-flex items-center p-1 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-full focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200"
                        type="button">
                        <span class="fa-solid fa-minus"></span>
                      </button>
                      <div>
                        <input type="number"
                          class="w-14 bg-[#ebecf0] !border-[#535A6640] rounded-md border !outline-[#535A6620] block px-2.5 py-1"
                          placeholder="0" required [(ngModel)]="insumo.cantidad"
                          (keyup)="updateQuantity(insumo.insumo , insumo.cantidad)">
                      </div>
                      <button (click)="addSupply(insumo.insumo , insumo.cantidad)"
                        class="inline-flex items-center p-1 text-sm font-medium text-gray-500 bg-white rounded-full border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200"
                        type="button">
                        <span class="fa-solid fa-plus"></span>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <table class="my_table w-full text-sm text-left text-neutral" *ngIf="params_delivery_id">
              <thead class="text-xs text-primary uppercase bg-[#dbdef1] border-b border-[#535a6650] sticky top-0">
                <tr>
                  <th scope="col" class="py-3 px-6">

                  </th>
                  <th scope="col" class="py-3 px-6">
                    Insumos
                  </th>
                  <th scope="col" class="py-3 px-6">
                    Cantidad
                  </th>
                </tr>
              </thead>
              <tbody *ngIf="!loading" class="divide-y-[0.5px] divide-[#535A6640]">
                <tr class="bg-white hover:bg-neutral-content transition-all"
                  *ngFor="let supply of currentSuppliesDelivery.detail_supplies_delivery;let index = index">
                  <th class="py-2 px-6 w-20">
                    <div class="w-12 h-12 flex justify-center items-center bg-[#3f51b530] rounded-md">
                      <span class="fas fa-syringe text-2xl text-primary flex justify-center items-center"></span>
                    </div>
                  </th>
                  <td class="py-2 px-6 font-medium text-neutral whitespace-nowrap dark:text-neutral capitalize">
                    {{supply.supply.value}}
                  </td>
                  <td class="py-2 px-6 w-20 text-center">
                    x{{supply.quantity}}
                  </td>
                </tr>
              </tbody>
              <tfoot class="border-t-2 border-[#535a6672]">
                <tr class="bg-white hover:bg-neutral-content transition-all">
                  <th class="py-2 px-6 font-medium text-center capitalize">
                    Total
                  </th>
                  <th class="py-2 px-6">{{currentSuppliesDelivery.detail_supplies_delivery.length}}</th>
                  <th class="py-2 px-6 w-20 text-center">
                    x{{TotalQuantity}}
                  </th>
                </tr>
              </tfoot>
            </table>


            <div *ngIf="loading || catalogoInsumos.length == 0" class="h-[calc(100vh-38rem+5px)]">
              <loader *ngIf="loading"></loader>
              <no-content *ngIf="catalogoInsumos.length == 0 && !loading && !params_delivery_id"></no-content>
            </div>
          </div>


          <div class="mt-5">
            <button [routerLink]="['/system/control-medico/entrega-insumos/follow']"
              class="btn btn-outline btn-primary text-xs text-primary rounded-md  flex justify-center items-center">
              <div class="flex justify-center items-center gap-2">
                <span class="fa-solid fa-arrow-left-long text-sm"></span>
                <span>Cancelar</span>
              </div>
            </button>
          </div>
        </div>

        <div class="w-96 h-full border border-[#535a6650] bg-white rounded-md" *ngIf="!params_delivery_id"
          [ngClass]="{'hidden': currentSuppliesDelivery.detail_supplies_delivery.length <= 0}">

          <div class="bg-[#dbdef1] border-b-[1px] border-[#535a6650] py-[12px] px-[24px]">
            <h1 class="text-xs text-primary uppercase font-bold ">Detalle de Insumos</h1>
          </div>
          <div class="h-[calc(100%-40px)] flex justify-between items-center flex-col">
            <div class="w-full p-4 flex flex-col overflow-y-auto">


              <div
                class="flex justify-between items-center border-[1px] border-[#535a6650] rounded-md mb-2 hover:bg-[#535a6610]"
                *ngFor="let detalle of currentSuppliesDelivery.detail_supplies_delivery">
                <div class="flex justify-center items-center text-neutral py-2 px-4 gap-4">
                  <div class="w-9 h-9 bg-[#3f51b530] rounded-md">
                    <span class="las la-syringe text-3xl text-primary flex justify-center items-center"></span>
                  </div>
                  <div>
                    <h1 class="font-bold text-sm">x{{detalle.quantity}}</h1>
                    <h1 class="truncate text-ellipsis overflow-hidden w-40">{{detalle.supply.value}}</h1>
                  </div>
                </div>
                <div class="mr-4" (click)="removeSupply(detalle.supply)">
                  <span class="fa-regular fa-square-minus hover:text-red-600 cursor-pointer"></span>
                </div>
              </div>

            </div>


            <div class="w-full flex justify-center items-center flex-col p-4">
              <div class="w-full flex justify-between items-center text-neutral py-2">
                <h3 class="uppercase text-xs font-medium">Total:</h3>
                <span
                  class="text-xs font-medium">{{currentSuppliesDelivery.detail_supplies_delivery.length}}/Insumos</span>
              </div>
              <button class="w-full btn btn-primary text-xs flex justify-center items-center gap-2"
                (click)="createSuppliesDelivery()">
                <span class="fa-solid fa-receipt"></span>
                Confirmar entrega
              </button>
            </div>
          </div>
        </div>

        <div class="w-96" *ngIf="params_delivery_id">

          <div class="h-14 py-4 flex justify-between items-center text-neutral">
            <h1 class="opacity-80 capitalize text-sm ">{{suppliesDeliveriesHistory.first_delivery | date: 'dd-MM-yyyy'}}
            </h1>
            <span>---></span>
            <h1 class="opacity-80 capitalize text-sm ">{{suppliesDeliveriesHistory.last_delivery | date: 'dd-MM-yyyy'}}
            </h1>
          </div>

          <div class="  border border-[#535a6650] bg-white rounded-md relative" *ngIf="params_delivery_id"
            [ngClass]="{'hidden': currentSuppliesDelivery.detail_supplies_delivery.length <= 0}">

            <div class="bg-[#dbdef1] border-b-[1px] border-[#535a6650] py-[12px] px-[24px]">
              <h1 class="text-xs text-primary uppercase font-bold ">Insumos totales del paciente</h1>
            </div>

            <div class="p-4">
              <div
                class="p-10 flex justify-center items-center border-[1px] border-[#535a6650] rounded-md mb-2 bg-[#535a6610]">
                <div class="flex justify-center items-end ">
                  <h1 class="text-5xl font-bold text-neutral">{{suppliesDeliveriesHistory.total_supplies_delivered}}
                  </h1>
                  <span class="las la-syringe text-2xl text-primary flex justify-center items-center"></span>
                </div>
              </div>

              <div
                class="flex justify-between items-center border-[1px] border-[#535a6650] rounded-md mb-2 hover:bg-[#535a6610]"
                *ngFor="let totalSupply of suppliesDeliveriesHistory.total_supplies_delivered_by_supply">
                <div class="flex justify-center items-center text-neutral py-2 px-4 gap-4">
                  <div class="w-9 h-9 bg-[#3f51b530] rounded-md">
                    <span class="las la-syringe text-3xl text-primary flex justify-center items-center"></span>
                  </div>
                  <div>
                    <h1 class="font-bold text-sm">x{{totalSupply.total}}</h1>
                    <h1 class="truncate text-ellipsis overflow-hidden w-40">{{totalSupply.supply}}</h1>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
